# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: grafana-service-accounts
spec:
  bindings:
    - name: NAMESPACE
      value: ($namespace)
    - name: USER
      value: root
    - name: PASS
      value: secret
    - name: NOW
      value: (time_now())
    - name: INSTANCENAME
      value: grafana1
    - name: SANAME
      value: sa1
  steps:
    - name: Create Grafana instance and Service Account
      try:
        - apply: {file: 010-deploy-grafana.yaml}
        - assert: {file: 010-assert.yaml}
        - apply: {file: 020-create-sa.yaml}
        - assert: {file: 020-assert.yaml}
    - name: Create a new service account without tokens
      try:
        - apply: {file: 040-sa-no-tokens.yaml}
        - assert: {file: 040-assert.yaml}
    - name: Add multiple tokens to service account
      try:
        - patch: {file: 090-add-tokens.yaml}
        - assert: {file: 090-assert.yaml}
    - name: Updating token expirations triggers reconciliation
      try:
        - patch: {file: 110-update-expirations.yaml}
        - assert:
            resource:
              # Chainsaw cannot correctly compare nil and list in assertions.
              # Workaround: wait for generation update, which guarantees changes are applied.
              apiVersion: grafana.integreatly.org/v1beta1
              kind: GrafanaServiceAccount
              metadata:
                name: grafana1-sa2
                namespace: ($NAMESPACE)
              status:
                conditions:
                  - observedGeneration: 7
        - assert: {file: 110-assert.yaml}
    - name: Remove token expirations
      try:
        - apply: {file: 120-remove-expirations.yaml}
        - assert: {file: 120-assert.yaml}
    - name: Delete token externally and verify restoration
      try:
        - script:
            # Delete token through Grafana API to simulate external deletion
            content: >
              kubectl exec -n $NS $DEPLOYMENT -- \
                curl --fail --silent --show-error -X DELETE -u $USER:$PASS \
                "http://localhost:3000/api/serviceaccounts/3/tokens/7"
            env:
              - name: USER
                value: ($USER)
              - name: PASS
                value: ($PASS)
              - name: NS
                value: ($NAMESPACE)
              - name: DEPLOYMENT
                value: deployment/grafana1-deployment
            check:
              ($error == null): true
        - script:
            content: >
              scripts/wait-token-deletion.sh 3 7 5s 1s

            env:
              - name: USER
                value: ($USER)
              - name: PASS
                value: ($PASS)
              - name: NS
                value: ($NAMESPACE)
              - name: DEPLOYMENT
                value: deployment/grafana1-deployment
            check:
              ($error == null): true
        - script: *reconcileSA2
        - assert: {file: 140-assert.yaml}
