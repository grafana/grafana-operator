# yaml-language-server: $schema=https://raw.githubusercontent.com/kyverno/chainsaw/main/.schemas/json/test-chainsaw-v1alpha1.json
apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: grafana-service-accounts
spec:
  bindings:
    - name: NAMESPACE
      value: ($namespace)
    - name: USER
      value: root
    - name: PASS
      value: secret
    - name: NOW
      value: (time_now())
    - name: INSTANCENAME
      value: grafana1
    - name: SANAME
      value: sa1
  steps:
    - name: Create Grafana instance and Service Account
      try:
        - apply: {file: 010-deploy-grafana.yaml}
        - assert: {file: 010-assert.yaml}
        - apply: {file: 020-create-sa.yaml}
        - assert: {file: 020-assert.yaml}
    - name: Create a new service account without tokens
      try:
        - apply: {file: 040-sa-no-tokens.yaml}
        - assert: {file: 040-assert.yaml}
    - name: Add multiple tokens to service account
      try:
        - patch: {file: 090-add-tokens.yaml}
        - assert: {file: 090-assert.yaml}
